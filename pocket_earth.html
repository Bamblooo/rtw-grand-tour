<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 环球旅行 - 袖珍地球</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: "PingFang SC", "Microsoft YaHei", "Segoe UI", sans-serif; color: white; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; transition: filter 1s ease; }
        
        /* Blur background when map is open */
        body.map-active #canvas-container { filter: blur(8px) brightness(0.3); }

        /* Transition Overlay */
        #transition-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 50; opacity: 0; pointer-events: none;
            transition: opacity 0.6s ease-in-out;
        }
        #transition-overlay.active { opacity: 1; pointer-events: auto; }

        /* UI Layer */
        #ui-layer {
            position: absolute; z-index: 20; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* 2D Map Overlay */
        #map-overlay {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 5; opacity: 0; pointer-events: none;
            transition: opacity 0.8s ease-in-out; background: #0f172a;
        }
        #map-overlay.visible { opacity: 1; pointer-events: auto; }

        /* Top Header */
        .header-overlay {
            padding: 40px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            transition: opacity 0.5s;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 600; letter-spacing: 2px; color: #94a3b8; }
        .trip-title { font-size: 36px; font-weight: 800; margin-top: 8px; color: white; text-shadow: 0 4px 12px rgba(0,0,0,0.5); letter-spacing: 1px; }

        /* Bottom Navigation Area */
        .nav-container {
            margin-bottom: 50px;
            display: flex; justify-content: center; align-items: center;
            gap: 20px;
            pointer-events: auto;
            width: 100%;
            z-index: 30;
        }

        /* Navigation Buttons (Floating Circles) */
        .nav-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 64px; height: 64px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .nav-btn:hover { background: white; color: black; transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.4); }
        .nav-btn:active { transform: translateY(0); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; background: rgba(0,0,0,0.2); color: #aaa; }

        /* The Info Card */
        .info-card {
            background: rgba(20, 20, 23, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 0;
            display: flex;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            width: 640px;
            max-width: 90%;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* Left Side: Date Box */
        .card-date-box {
            background: #2563eb; 
            min-width: 110px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white;
            padding: 0 10px;
        }
        .card-date-box.flight { background: #eab308; color: black; } 
        .card-date-box.hotel { background: #3b82f6; } 
        .card-date-box.activity { background: #10b981; } 
        
        .date-month { font-size: 16px; font-weight: 700; letter-spacing: 1px; opacity: 0.9; }
        .date-day { font-size: 36px; font-weight: 800; line-height: 1; margin: 4px 0; }

        /* Right Side: Content */
        .card-content {
            flex-grow: 1;
            padding: 24px 28px;
            display: flex; flex-direction: column;
            justify-content: center;
            text-align: left;
        }

        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        .type-tag {
            font-size: 13px; font-weight: 700; letter-spacing: 1px;
            padding: 6px 10px; border-radius: 6px;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .type-tag.flight { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .type-tag.hotel { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .type-tag.activity { background: rgba(16, 185, 129, 0.2); color: #34d399; }

        .phase-text { font-size: 14px; color: #94a3b8; font-weight: 600; letter-spacing: 0.5px; }

        .main-title {
            font-size: 22px; font-weight: 700; color: #f8fafc; margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
        }

        .sub-title {
            font-size: 15px; color: #cbd5e1; display: flex; align-items: center; gap: 8px;
            font-weight: 500;
        }
        .sub-title i { font-size: 18px; color: #94a3b8; }

        /* Marker Tooltip */
        #marker-tooltip {
            position: absolute; background: rgba(15, 23, 42, 0.95); border: 1px solid #475569;
            padding: 8px 12px; border-radius: 6px; font-size: 14px; display: none; z-index: 20; 
            pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5); color: white; white-space: nowrap;
        }
    </style>
    
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>

    <div id="transition-overlay"></div>
    <div id="map-overlay"></div>

    <div id="ui-layer">
        <div class="header-overlay">
            <h1>Pocket Earth</h1>
            <div class="trip-title">环球旅游</div>
        </div>

        <div class="nav-container">
            <button id="btn-prev" class="nav-btn"><i class="ph ph-caret-left"></i></button>
            <div class="info-card">
                <div id="card-date-box" class="card-date-box hotel">
                    <span id="ui-month" class="date-month">1月</span>
                    <span id="ui-day" class="date-day">29</span>
                </div>
                <div class="card-content">
                    <div class="card-header-row">
                        <div id="ui-type-tag" class="type-tag hotel">
                            <i class="ph ph-bed"></i> <span>入住</span>
                        </div>
                        <span id="ui-phase" class="phase-text">第一阶段</span>
                    </div>
                    <div id="ui-title" class="main-title">Grand Hyatt at SFO</div>
                    <div class="sub-title">
                        <i class="ph ph-map-pin"></i>
                        <span id="ui-desc">旧金山机场出发</span>
                    </div>
                </div>
            </div>
            <button id="btn-next" class="nav-btn"><i class="ph ph-caret-right"></i></button>
        </div>
    </div>
    
    <div id="marker-tooltip"></div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const EARTH_ROTATION_OFFSET = -Math.PI / 2;

        // ==========================================
        // 2026 真实行程数据 (国际段英文名，中台段中文名)
        // ==========================================
        const myItinerary = [
            // --- 阶段1: 北美 & 墨西哥 ---
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'Grand Hyatt at SFO', location: '旧金山机场', 
                lat: 37.62, lon: -122.39, date: '1/29', price: '$459',
                desc: '跑道景观无敌！专门为爱摄影的你们选的，拿着长焦镜头在房间就能拍到飞机起降的震撼画面，作为环球旅行的起点再合适不过。' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'flight', 
                name: 'SFO ➔ MEX', location: '旧金山 飞往 墨西哥城',
                fromCoords: [37.62, -122.39], toCoords: [19.43, -99.07], date: '1/30', 
                desc: '航班 UA817 · 飞行时长约 4.5 小时' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'Hotel San Fernando', location: '墨西哥城 · 康德萨区',
                lat: 19.41, lon: -99.16, date: '1/30', price: '$285',
                desc: '粉色外墙超级上镜，就在最时髦的Condesa区，下楼就是满街的咖啡香和蓝花楹，感受墨西哥城的文艺范儿。' 
            },
            { phase: "第一阶段：北美与墨西哥", type: 'flight', name: 'MEX ➔ TQO', location: '墨西哥城 飞往 图卢姆', fromCoords: [19.43, -99.07], toCoords: [20.21, -87.43], date: '1/31', desc: '航班 AM0594 · 前往海滨古城' },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'La Valise Tulum', location: '图卢姆 · 精品度假',
                lat: 20.14, lon: -87.45, date: '1/31', price: '$1,250',
                desc: '只有11间房的私密天堂，一定要把那张可以滑到露台上的大床推出去，躺在床上看加勒比海日出！' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'TAGO Tulum', location: '图卢姆 · SLH',
                lat: 20.15, lon: -87.44, date: '2/1', price: '$890',
                desc: '每个房间都有私人泳池，私密性极好。设计融合了玛雅文化和现代奢华，拍照完全不需要滤镜。' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'Hyatt Ziva Cancun', location: '坎昆 · 绝美海景',
                lat: 21.13, lon: -86.74, date: '2/2', price: '$920',
                desc: '三面环海的绝佳位置！订了转角海景房，一定要去海豚池旁边的那个餐厅占个座，边吃饭边看海豚表演。' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'Impression Moxché by Secrets', location: 'Secrets · 印象系列',
                lat: 20.65, lon: -87.03, date: '2/3', price: '$1,450',
                desc: '全球唯二的印象系列，这里的质感简直是为摄影师量身定做。不仅是全包，更是全方位的艺术体验。' 
            },
            { 
                phase: "第一阶段：北美与墨西哥", type: 'hotel', 
                name: 'Hyatt Centric Playa del Carmen', location: '普拉亚德尔卡曼',
                lat: 20.62, lon: -87.07, date: '2/4', price: '$350',
                desc: '就在第五大道旁边，热闹非凡。潜水回来后，下楼就能逛街吃Taco，感受最地道的墨西哥生活气息。' 
            },
            { phase: "第一阶段：北美与墨西哥", type: 'flight', name: 'CUN ➔ LIS', location: '坎昆 飞往 里斯本', fromCoords: [21.04, -86.87], toCoords: [38.77, -9.13], date: '2/6', desc: '航班 TP278 · 跨大西洋飞行' },

            // --- 阶段2: 欧洲 ---
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'The Ivens, Autograph Collection', location: '里斯本',
                lat: 38.71, lon: -9.14, date: '2/7', price: '$580',
                desc: '以19世纪探险家为主题的设计，这里的丛林风酒吧可是里斯本最潮的打卡点，复古又狂野。' 
            },
            { phase: "第二阶段：欧洲巡礼", type: 'flight', name: 'LIS ➔ ORY', location: '里斯本 飞往 巴黎', fromCoords: [38.77, -9.13], toCoords: [48.72, 2.36], date: '2/8', desc: '航班 TP0434 · 前往巴黎' },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Hôtel du Louvre', location: '巴黎 · 卢浮宫旁',
                lat: 48.86, lon: 2.33, date: '2/8', price: '$720',
                desc: '位置无敌！窗外就是卢浮宫，早上趁游客还没来，去广场拍空无一人的金字塔，这才是巴黎的正确打开方式。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Le Bristol Paris', location: '巴黎 · 宫殿级',
                lat: 48.87, lon: 2.31, date: '2/9', price: '$2,800',
                desc: '真正的巴黎宫殿级酒店，《午夜巴黎》取景地。一定要去花园找那只叫Socrate的猫咪合影，它可是这里的明星！' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Park Hyatt Paris-Vendôme', location: '巴黎 · 旺多姆广场',
                lat: 48.86, lon: 2.32, date: '2/10', price: '$1,950',
                desc: '低调奢华的天花板，位置极佳。据说他们的早餐可颂是巴黎最好吃的之一，配上一杯咖啡，就是完美的法式早晨。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Ritz Paris', location: '巴黎 · 传奇',
                lat: 48.86, lon: 2.32, date: '2/11', price: '$3,200',
                desc: '海明威说“当我想象死后的天堂，就是丽兹的样子”。七周年纪念日住这里简直完美，不仅仅是酒店，更是一段传奇历史。' 
            },
            { phase: "第二阶段：欧洲巡礼", type: 'flight', name: 'CDG ➔ FCO', location: '巴黎 飞往 罗马', fromCoords: [49.00, 2.55], toCoords: [41.80, 12.24], date: '2/12', desc: '航班 AF1304 · 前往意大利' },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Palazzo Manfredi', location: '罗马 · 斗兽场',
                lat: 41.89, lon: 12.49, date: '2/12', price: '$1,100',
                desc: '吃早餐时斗兽场就在手边，这种史诗感只有住这里才有。记得在露台餐厅Aroma订位，那是看罗马夜景的最佳机位。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Palazzo Talia', location: '罗马 · SLH',
                lat: 41.90, lon: 12.48, date: '2/13', price: '$850',
                desc: '藏在古老学院里的新贵，设计超级前卫，红毯楼梯是必拍点。古典与现代的碰撞，非常适合你们的审美。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Four Seasons Firenze', location: '佛罗伦萨',
                lat: 43.77, lon: 11.26, date: '2/14', price: '$1,600',
                desc: '拥有佛罗伦萨最大的私人花园，仿佛穿越回了文艺复兴时期。这里的每一寸壁画和雕塑都是艺术品，住这就相当于住在博物馆里。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name_en: 'Sina The Gray', name: 'Sina The Gray', location: '米兰 · 大教堂旁',
                lat: 45.46, lon: 9.19, date: '2/15', price: '$680',
                desc: '位置无敌！有些房间的露台甚至能直接看到大教堂的尖顶细节，出门左转就是埃马努埃莱二世拱廊，购物极其方便。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Hotel Flüela Davos', location: '达沃斯 · 滑雪',
                lat: 46.80, lon: 9.83, date: '2/16', price: '$750',
                desc: '这可是世界经济论坛期间大佬们住的地方，历史悠久。在冰雪世界里体验一把顶级的老牌瑞士服务。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Me and All Hotel Flims', location: '弗利姆斯',
                lat: 46.83, lon: 9.28, date: '2/17', price: '$420',
                desc: '年轻时髦的设计酒店，工业风和阿尔卑斯风情的结合。露台上的风景简直就是一副油画，非常适合放松。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Hotel Royal St. Georges', location: '因特拉肯',
                lat: 46.68, lon: 7.86, date: '2/18', price: '$550',
                desc: '像住在韦斯·安德森的电影布景里，复古又优雅。连接着两座湖泊，抬头就能看见少女峰，地理位置绝佳。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Petit Helvetia Budget Hotel', location: '采尔马特',
                lat: 46.02, lon: 7.74, date: '2/19', price: '$280',
                desc: '虽然叫Budget，但体验一点不打折！就在策尔马特小镇中心，超级温馨，出门就是滑雪场，感受最纯粹的瑞士山居生活。' 
            },
            { 
                phase: "第二阶段：欧洲巡礼", type: 'hotel', 
                name: 'Park Hyatt Milan', location: '米兰',
                lat: 45.46, lon: 9.18, date: '2/21', price: '$1,400',
                desc: '就在那个著名的拱廊里！全米兰最时尚的心脏地带，大堂吧是米兰时装周期间撞星率最高的地方。' 
            },

            // --- 阶段3: 土耳其 & 马尔代夫 ---
            { phase: "第三阶段：土耳其与马尔代夫", type: 'flight', name: 'MXP ➔ IST', location: '米兰 飞往 伊斯坦布尔', fromCoords: [45.63, 8.72], toCoords: [41.26, 28.74], date: '2/22', desc: '航班 TK1896 · 土耳其航空' },
            { 
                phase: "第三阶段：土耳其与马尔代夫", type: 'hotel', 
                name: 'The Ritz-Carlton, Istanbul', location: '伊斯坦布尔',
                lat: 41.04, lon: 28.99, date: '2/22', price: '$650',
                desc: '俯瞰博斯普鲁斯海峡，左手欧洲右手亚洲。一定要去拿那只限量版的土耳其风情小狮子！' 
            },
            { phase: "第三阶段：土耳其与马尔代夫", type: 'flight', name: 'IST ➔ MLE', location: '伊斯坦布尔 飞往 马尔代夫', fromCoords: [41.26, 28.74], toCoords: [4.17, 73.53], date: '2/24', desc: '航班 TK734 · 前往海岛' },
            { 
                phase: "第三阶段：土耳其与马尔代夫", type: 'hotel', 
                name: 'Huvafen Fushi', location: '马尔代夫 · 水下SPA',
                lat: 4.36, lon: 73.36, date: '2/24', price: '$1,900',
                desc: '这里有全球第一家水下SPA，做护理的时候小鱼就在旁边游！为了这一刻的独特体验，这钱花得绝对值。' 
            },
            { 
                phase: "第三阶段：土耳其与马尔代夫", type: 'hotel', 
                name: 'Milaidhoo Maldives', location: '马尔代夫 · 芭环礁',
                lat: 5.26, lon: 73.12, date: '2/26', price: '$2,400',
                desc: '位于联合国教科文组织保护区，不穿鞋的奢华体验。潜水环境一流，运气好能看到魔鬼鱼风暴！' 
            },

            // --- 阶段4: 东南亚 ---
            { phase: "第四阶段：东南亚", type: 'flight', name: 'MLE ➔ SIN', location: '马尔代夫 飞往 新加坡', fromCoords: [4.17, 73.53], toCoords: [1.36, 103.99], date: '3/1', desc: '航班 SQ431 · 新加坡航空' },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Raffles Singapore', location: '新加坡 · 传奇',
                lat: 1.29, lon: 103.85, date: '3/1', price: '$1,350',
                desc: '亚洲最传奇的酒店之一，一定要去Long Bar点一杯原创的新加坡司令，连门童都是合影打卡的景点。' 
            },
            { phase: "第四阶段：东南亚", type: 'flight', name: 'SIN ➔ DPS', location: '新加坡 飞往 巴厘岛', fromCoords: [1.36, 103.99], toCoords: [-8.74, 115.16], date: '3/2', desc: '航班 SQ944 · 前往印尼' },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Umana Bali, LXR', location: '巴厘岛 · 悬崖',
                lat: -8.82, lon: 115.14, date: '3/2', price: '$980',
                desc: '希尔顿旗下的顶级奢牌，每一栋别墅都能看到震撼的海景，设计灵感来自巴厘岛的梯田，非常壮观。' 
            },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Alila Villas Uluwatu', location: '巴厘岛 · 乌鲁瓦图',
                lat: -8.84, lon: 115.12, date: '3/3', price: '$1,150',
                desc: '那个悬崖鸟笼是巴厘岛的地标，也是你们七周年的最佳背景。这里的环保设计理念非常超前，建筑摄影绝佳。' 
            },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Alila Ubud', location: '巴厘岛 · 乌布',
                lat: -8.45, lon: 115.23, date: '3/4', price: '$450',
                desc: '这里的无边泳池是鼻祖级别的，感觉像在热带雨林的树梢上游泳，清晨的云雾简直仙气飘飘。' 
            },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Viceroy Bali', location: '巴厘岛 · 奢华',
                lat: -8.50, lon: 115.27, date: '3/5', price: '$820',
                desc: '家族经营的奢华酒店，皇室般的待遇，直升机停机坪都备好了，极度私密，适合只想静静享受二人世界的你们。' 
            },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Mathis Lodge Amed', location: '巴厘岛 · 艾湄湾',
                lat: -8.33, lon: 115.66, date: '3/6', price: '$320',
                desc: '远离喧嚣的东部，这里能看到最原始的巴厘岛和最清的海水。住在山上俯瞰大海，潜水回来后在露台发呆最舒服。' 
            },
            { 
                phase: "第四阶段：东南亚", type: 'hotel', 
                name: 'Desa Potato Head', location: '巴厘岛 · 水明漾',
                lat: -8.68, lon: 115.15, date: '3/7', price: '$480',
                desc: '环保又时髦，这里是巴厘岛最酷的日落派对聚集地。建筑全是回收材料做的，非常有创意，年轻人最爱。' 
            },

            // --- 阶段5: 东亚 (中文区 - 中文名) ---
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '台北 W 酒店', location: '台北 · 信义区',
                lat: 25.04, lon: 121.56, date: '3/8', price: '$380',
                desc: '就在101旁边，夜景无敌，时尚潮人的聚集地。泳池派对非常有氛围，是感受台北夜生活的最佳据点。' 
            },
            { phase: "第五阶段：东亚", type: 'flight', name: 'KHH ➔ SHA', location: '高雄 飞往 上海', fromCoords: [22.57, 120.34], toCoords: [31.19, 121.33], date: '3/12', desc: '航班 BR706 · 直飞上海' },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '上海前滩华尔道夫', location: '上海 · 前滩',
                lat: 31.15, lon: 121.48, date: '3/13', price: '$650',
                desc: '为了那只限定版的小熊也要住一次！浦江新景致，设施非常新，服务也是没得挑。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '上海和平饭店', location: '上海 · 外滩',
                lat: 31.24, lon: 121.48, date: '3/14', price: '$780',
                desc: '宝总同款！这不仅仅是酒店，这是上海滩的历史博物馆。在爵士吧听听老年爵士乐团的演奏，穿越回那个年代。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '北京柏悦酒店', location: '北京 · 长安街',
                lat: 39.90, lon: 116.45, date: '3/15', price: '$580',
                desc: '在北京最高处醒来，脚下就是长安街，视野无敌霸气。极简的设计风格非常出片。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '北京王府井文华东方', location: '北京 · 王府井',
                lat: 39.91, lon: 116.41, date: '3/17', price: '$1,100',
                desc: '只有73间房的奢华精品，露台上看夕阳下的紫禁城金顶，绝对是人生高光时刻，非常难忘。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '北京华尔道夫酒店', location: '北京 · 金鱼胡同',
                lat: 39.92, lon: 116.41, date: '3/18', price: '$720',
                desc: '全铜外观会随着时间变色，非常有质感。别忘了收集北京限定的红丝绒蛋糕，带给爸妈尝尝。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '杭州秋水山庄', location: '杭州 · 西湖',
                lat: 30.26, lon: 120.15, date: '3/20', price: '$1,800',
                desc: '杭州酒店的天花板，只有8间房，住的是民国风骨。每一个细节都极其讲究，是陪父母体验江南文化的最佳选择。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: '上海宝格丽酒店', location: '上海 · 苏河湾',
                lat: 31.24, lon: 121.48, date: '3/22', price: '$1,300',
                desc: '名媛聚集地，但风景是真的好，记得去顶层露台喝一杯，俯瞰苏州河与黄浦江交汇，感受魔都魅力。' 
            },
            
            // --- 阶段5: 东亚 (日本 - 英文) ---
            { phase: "第五阶段：东亚", type: 'flight', name: 'PVG ➔ KIX', location: '上海 飞往 大阪', fromCoords: [31.14, 121.80], toCoords: [34.43, 135.23], date: '3/27', desc: '航班 NH976 · 前往关西' },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'Sowaka Kyoto', location: '京都 · 祗园',
                lat: 35.00, lon: 135.78, date: '3/27', price: '$950',
                desc: '住进百年前的京都老宅，感受那种侘寂之美。位置极好，就在八坂神社旁边，非常难订！' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'Suiran, a Luxury Collection Hotel', location: '京都 · 岚山',
                lat: 35.01, lon: 135.67, date: '3/28', price: '$1,200',
                desc: '在岚山深处，一定要体验他们的“香槟欢乐时光”，看着保津川发呆，避开游客的喧嚣，独享岚山。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'ROKU KYOTO', location: '京都 · 鹰峰',
                lat: 35.05, lon: 135.73, date: '3/29', price: '$1,100',
                desc: '希尔顿LXR品牌，在鹰峰山脚下泡着天然温泉，设计非常现代禅意，秋天看红叶春天看新绿，绝美。' 
            },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'The Ritz-Carlton, Kyoto', location: '京都 · 鸭川',
                lat: 35.01, lon: 135.77, date: '4/1', price: '$1,800',
                desc: '鸭川边的低调奢华，一定要参加他们的晨间骑行活动。为了那只和服狮子公仔，也得来住一次！' 
            },
            { phase: "第五阶段：东亚", type: 'flight', name: 'KIX ➔ CTS', location: '大阪 飞往 札幌', fromCoords: [34.43, 135.23], toCoords: [42.77, 141.69], date: '4/2', desc: '航班 · 前往北海道' },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'Park Hyatt Niseko Hanazono', location: '北海道 · 二世谷',
                lat: 42.86, lon: 140.70, date: '4/2', price: '$1,500',
                desc: '出门就是粉雪天堂，滑完雪回来泡个温泉，看着窗外的雪景，这就是人生赢家的感觉。' 
            },
            { phase: "第五阶段：东亚", type: 'flight', name: 'CTS ➔ HND', location: '札幌 飞往 东京', fromCoords: [42.77, 141.69], toCoords: [35.54, 139.77], date: '4/4', desc: '航班 JL526 · 前往东京' },
            { 
                phase: "第五阶段：东亚", type: 'hotel', 
                name: 'Park Hyatt Tokyo', location: '东京 · 新宿',
                lat: 35.68, lon: 139.69, date: '4/4', price: '$1,300',
                desc: '《迷失东京》的取景地，翻修后重开。在New York Bar听着爵士乐看东京塔，这是对这次环球旅行最好的告别。' 
            },
            { phase: "第五阶段：东亚", type: 'flight', name: 'NRT ➔ MEX', location: '东京 飞往 墨西哥城', fromCoords: [35.77, 140.39], toCoords: [19.43, -99.07], date: '4/5', desc: '航班 NH180 · 跨太平洋返回' },
            { phase: "第五阶段：东亚", type: 'flight', name: 'MEX ➔ SFO', location: '墨西哥城 飞往 旧金山', fromCoords: [19.43, -99.07], toCoords: [37.62, -122.39], date: '4/13', desc: '航班 UA820 · 圆满回家' }
        ];

        // --- 配置 ---
        const config = {
            colors: {
                flight: 0xfacc15,
                hotel: 0x3b82f6,
                activity: 0x10b981
            },
            textures: {
                map: 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
                borders: 'https://raw.githubusercontent.com/vaibhav111tandon/3d-globe/master/src/img/earth-borders.png'
            }
        };

        // --- 初始化 2D 地图 (Leaflet) ---
        const mapOverlay = document.getElementById('map-overlay');
        const leafletMap = L.map('map-overlay', { zoomControl: false, attributionControl: false }).setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(leafletMap);

        let isMapVisible = false;
        function show2DMap(lat, lon) {
            leafletMap.setView([lat, lon], 14); 
            leafletMap.eachLayer((layer) => { if (layer instanceof L.Marker) layer.remove(); });
            L.marker([lat, lon]).addTo(leafletMap);
            mapOverlay.classList.add('visible');
            document.body.classList.add('map-active');
            isMapVisible = true;
        }
        function hide2DMap() {
            if (!isMapVisible) return;
            mapOverlay.classList.remove('visible');
            document.body.classList.remove('map-active');
            isMapVisible = false;
        }

        // --- Three.js 场景初始化 ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2.8;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 1.05; 
        controls.maxDistance = 6;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.enablePan = false;

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(5, 3, 5);
        scene.add(dirLight);

        // --- 地球 & 边界 ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const texLoader = new THREE.TextureLoader();
        
        // 1. 地球模型 - 应用旋转校准
        const earthMesh = new THREE.Mesh(
            new THREE.SphereGeometry(1, 64, 64),
            new THREE.MeshPhongMaterial({ 
                map: texLoader.load(config.textures.map),
                specular: new THREE.Color(0x111111),
                shininess: 5 
            })
        );
        earthMesh.rotation.y = EARTH_ROTATION_OFFSET; 
        earthGroup.add(earthMesh);

        // 2. 边界模型 - 应用旋转校准
        const borderMesh = new THREE.Mesh(
            new THREE.SphereGeometry(1.002, 64, 64),
            new THREE.MeshBasicMaterial({
                map: texLoader.load(config.textures.borders),
                transparent: true, opacity: 0.6, side: THREE.DoubleSide
            })
        );
        borderMesh.rotation.y = EARTH_ROTATION_OFFSET; 
        earthGroup.add(borderMesh);
        
        // 大气层
        const atmos = new THREE.Mesh(
            new THREE.SphereGeometry(1.1, 64, 64),
            new THREE.ShaderMaterial({
                vertexShader: `varying vec3 vN;void main(){vN=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
                fragmentShader: `varying vec3 vN;void main(){float i=pow(0.6-dot(vN,vec3(0,0,1)),3.0);gl_FragColor=vec4(0.4,0.7,1.0,1.0)*i;}`,
                side: THREE.BackSide, blending: THREE.AdditiveBlending, transparent: true
            })
        );
        scene.add(atmos);

        function latLonToVec3(lat, lon, r) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180) + EARTH_ROTATION_OFFSET;
            
            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const z = (r * Math.sin(phi) * Math.sin(theta));
            const y = (r * Math.cos(phi));
            return new THREE.Vector3(x, y, z);
        }

        // --- 渲染逻辑 ---
        const objects = []; 
        
        myItinerary.forEach((item, index) => {
            if (item.type === 'flight') {
                const start = latLonToVec3(item.fromCoords[0], item.fromCoords[1], 1.0);
                const end = latLonToVec3(item.toCoords[0], item.toCoords[1], 1.0);
                
                const dist = start.distanceTo(end);
                const mid = start.clone().add(end).multiplyScalar(0.5).normalize().multiplyScalar(1 + dist * 0.4);
                
                const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
                const points = curve.getPoints(50);
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: config.colors.flight, linewidth: 2, transparent: true, opacity: 0.8 });
                const line = new THREE.Line(geometry, material);
                earthGroup.add(line);
            } 
            else {
                const pos = latLonToVec3(item.lat, item.lon, 1.02); 
                let color = item.type === 'hotel' ? config.colors.hotel : config.colors.activity;
                
                const pinGroup = new THREE.Group();
                pinGroup.position.copy(pos);
                pinGroup.lookAt(new THREE.Vector3(0,0,0)); 
                
                const stick = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.002, 0.002, 0.04),
                    new THREE.MeshBasicMaterial({ color: 0xffffff })
                );
                stick.rotation.x = Math.PI / 2; 
                stick.position.z = -0.02; 
                
                pinGroup.lookAt(pos.clone().multiplyScalar(2)); // 朝外看

                stick.position.z = 0.02; 
                pinGroup.add(stick);

                const head = new THREE.Mesh(
                    new THREE.SphereGeometry(0.012, 16, 16),
                    new THREE.MeshBasicMaterial({ color: color })
                );
                head.position.z = 0.04; // 顶部
                pinGroup.add(head);

                head.userData = { isMarker: true, ...item };
                objects.push(head);
                earthGroup.add(pinGroup);
                
                item.markerRef = head;
            }
        });

        // --- 导航控制 ---
        let currentIndex = 0; // Initialize to 0, not -1
        let isAnimating = false; // Guard against rapid clicks
        const transitionOverlay = document.getElementById('transition-overlay');

        const ui = {
            cardDateBox: document.getElementById('card-date-box'),
            month: document.getElementById('ui-month'),
            day: document.getElementById('ui-day'),
            typeTag: document.getElementById('ui-type-tag'),
            phase: document.getElementById('ui-phase'),
            title: document.getElementById('ui-title'),
            desc: document.getElementById('ui-desc'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next')
        };

        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            // 中文月份
            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            const monthIdx = parseInt(parts[0]) - 1;
            return { month: monthNames[monthIdx] || "", day: parts[1] };
        }

        function updateStep(index) {
            if (isAnimating) return; // Block input if animating
            
            if (index < 0) index = 0;
            if (index >= myItinerary.length) index = myItinerary.length - 1;
            
            currentIndex = index;
            const item = myItinerary[currentIndex];

            const dateObj = parseDate(item.date);
            ui.month.innerText = dateObj.month;
            ui.day.innerText = dateObj.day;
            ui.phase.innerText = item.phase;
            ui.title.innerText = item.name;
            ui.desc.innerText = item.desc;

            ui.cardDateBox.className = 'card-date-box';
            ui.typeTag.className = 'type-tag';
            
            let iconHtml = '';
            let typeLabel = '';
            
            if (item.type === 'flight') {
                ui.cardDateBox.classList.add('flight');
                ui.typeTag.classList.add('flight');
                iconHtml = '<i class="ph ph-airplane-tilt"></i>';
                typeLabel = '航班';
            } else if (item.type === 'hotel') {
                ui.cardDateBox.classList.add('hotel');
                ui.typeTag.classList.add('hotel');
                iconHtml = '<i class="ph ph-bed"></i>';
                typeLabel = '入住';
            } else {
                ui.cardDateBox.classList.add('activity');
                ui.typeTag.classList.add('activity');
                iconHtml = '<i class="ph ph-ticket"></i>';
                typeLabel = '游玩';
            }
            ui.typeTag.innerHTML = `${iconHtml} <span>${typeLabel}</span>`;

            objects.forEach(obj => obj.scale.set(1,1,1));
            if (item.markerRef) {
                item.markerRef.scale.set(2.0, 2.0, 2.0);
            }
            
            controls.autoRotate = false;
            let lat, lon;
            if (item.type === 'flight') {
                [lat, lon] = item.toCoords;
            } else {
                lat = item.lat;
                lon = item.lon;
            }

            const isFlight = (item.type === 'flight');
            hide2DMap();

            isAnimating = true; // Lock
            if (isFlight) {
                flyTo(lat, lon, () => { 
                    show2DMap(lat, lon); 
                    isAnimating = false; // Unlock
                });
            } else {
                fadeTransitionTo(lat, lon, () => { 
                    show2DMap(lat, lon); 
                    isAnimating = false; // Unlock
                });
            }

            ui.btnPrev.disabled = (currentIndex === 0);
            ui.btnNext.disabled = (currentIndex === myItinerary.length - 1);
        }

        ui.btnPrev.onclick = () => updateStep(currentIndex - 1);
        ui.btnNext.onclick = () => updateStep(currentIndex + 1);

        function fadeTransitionTo(lat, lon, onComplete) {
            transitionOverlay.classList.add('active');
            setTimeout(() => {
                const closeZoom = 1.05;
                const targetPos = latLonToVec3(lat, lon, closeZoom);
                camera.position.copy(targetPos);
                camera.lookAt(0,0,0);
                controls.update();
                setTimeout(() => {
                    transitionOverlay.classList.remove('active');
                    if(onComplete) onComplete();
                }, 100); 
            }, 600); 
        }

        let flyAnimationId = null;
        function flyTo(lat, lon, onComplete) {
            if (flyAnimationId) cancelAnimationFrame(flyAnimationId);
            
            const closeZoom = 1.05; 
            const peakZoom = 4.0;
            
            const targetPos = latLonToVec3(lat, lon, closeZoom);
            const targetDir = targetPos.clone().normalize();

            const startPos = camera.position.clone();
            const startDir = startPos.clone().normalize();
            const startDist = startPos.length();

            let startTime = Date.now();
            const duration = 2500; 

            function animateFrame() {
                const now = Date.now();
                let progress = (now - startTime) / duration;
                
                if (progress >= 1) {
                    camera.position.copy(targetPos);
                    camera.lookAt(0,0,0);
                    controls.update();
                    if (onComplete) onComplete();
                    return;
                }

                const ease = progress < 0.5 ? 4 * progress * progress * progress : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                const currentDir = new THREE.Vector3().copy(startDir).lerp(targetDir, ease).normalize();

                const midBase = (startDist + closeZoom) / 2;
                const bumpHeight = Math.max(0, peakZoom - midBase);
                const arc = Math.sin(progress * Math.PI);
                const baseDist = startDist + (closeZoom - startDist) * ease;
                const finalDist = baseDist + (bumpHeight * arc);

                camera.position.copy(currentDir).multiplyScalar(finalDist);
                camera.lookAt(0,0,0);
                controls.update();

                flyAnimationId = requestAnimationFrame(animateFrame);
            }
            flyAnimationId = requestAnimationFrame(animateFrame);
        }

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const tooltip = document.getElementById('marker-tooltip');

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects);
            if(intersects.length > 0) {
                const data = intersects[0].object.userData;
                tooltip.style.display = 'block';
                tooltip.style.left = e.clientX + 15 + 'px';
                tooltip.style.top = e.clientY + 15 + 'px';
                tooltip.innerText = data.name;
                document.body.style.cursor = 'pointer';
            } else {
                tooltip.style.display = 'none';
                document.body.style.cursor = 'default';
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Force init first step to sync map/camera/UI
        setTimeout(() => {
            updateStep(0);
        }, 1000);

    </script>
</body>
</html>